{% extends "layout/base.html" %}

{% block title %}Subir Modelo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Estilos para las zonas de carga */
    .upload-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .upload-box {
        position: relative;
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        background: #f8fafc;
        padding: 2rem 1rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-box:hover {
        border-color: var(--primary-color);
        background: #eff6ff;
        transform: translateY(-2px);
    }

    .upload-box.active {
        border-color: var(--success-color);
        background: #ecfdf5;
    }

    .upload-box input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
    }

    .icon-large {
        font-size: 2.5rem;
        color: #94a3b8;
        margin-bottom: 10px;
        transition: color 0.3s;
    }

    .upload-box:hover .icon-large { color: var(--primary-color); }
    .upload-box.active .icon-large { color: var(--success-color); }

    .file-name {
        margin-top: 10px;
        font-size: 0.85rem;
        color: var(--primary-color);
        font-weight: bold;
        word-break: break-all;
    }

    /* Estilos para los resultados */
    .results-container {
        display: none; /* Oculto por defecto */
        margin-top: 2rem;
        border-top: 1px solid #e2e8f0;
        padding-top: 2rem;
        text-align: left;
    }

    .tag-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }

    .tag {
        background: #e2e8f0;
        color: #475569;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    @media (max-width: 600px) {
        .upload-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block nav_left %}
    {% if origen == 'entrenar' %}
        <a href="{{ url_for('web.entrenar') }}" class="header-btn">
            <i class="fas fa-arrow-left"></i> Volver a Entrenar
        </a>
    {% else %}
        <a href="{{ url_for('web.opciones') }}" class="header-btn">
            <i class="fas fa-arrow-left"></i> Panel
        </a>
    {% endif %}
{% endblock %}

{% block content %}
    <div class="card-panel" style="max-width: 700px;">
        <h2 style="margin-bottom: 0.5rem;"><i class="fas fa-cloud-upload-alt"></i> Actualizar IA</h2>
        <p style="color: #64748b; margin-bottom: 2rem;">Sube los archivos <code>.zip</code> generados por Teachable Machine para actualizar el reconocimiento.</p>

        <form id="model-upload-form">
            <div class="upload-grid">
                
                <div class="upload-box" id="box-form">
                    <input type="file" id="form_model" name="form_model" accept=".zip" required>
                    <i class="fas fa-shapes icon-large"></i>
                    <h3>Modelo de Formas</h3>
                    <p style="font-size: 0.8rem; color: #64748b;">Arrastra o clic aquí</p>
                    <div id="name-form" class="file-name"></div>
                </div>

                <div class="upload-box" id="box-color">
                    <input type="file" id="color_model" name="color_model" accept=".zip" required>
                    <i class="fas fa-palette icon-large"></i>
                    <h3>Modelo de Colores</h3>
                    <p style="font-size: 0.8rem; color: #64748b;">Arrastra o clic aquí</p>
                    <div id="name-color" class="file-name"></div>
                </div>

            </div>

            <button type="submit" id="submit-btn" class="btn-primary" style="width: 100%; font-size: 1.1rem;">
                <i class="fas fa-upload"></i> Subir y Actualizar
            </button>
        </form>

        <div id="model-info" class="results-container">
            <div style="background: #ecfdf5; padding: 1rem; border-radius: 8px; border: 1px solid #10b981; margin-bottom: 1.5rem; text-align: center;">
                <i class="fas fa-check-circle" style="color: #059669;"></i> 
                <span style="color: #065f46; font-weight: bold;">¡Actualización Exitosa!</span>
            </div>

            <div class="dashboard-grid" style="margin-top: 0; justify-content: flex-start;">
                <div style="flex: 1; min-width: 250px;">
                    <h4 style="color: var(--primary-color);"><i class="fas fa-shapes"></i> Nuevas Formas</h4>
                    <div class="tag-cloud" id="form-labels-list"></div>
                </div>

                <div style="flex: 1; min-width: 250px;">
                    <h4 style="color: var(--primary-color);"><i class="fas fa-palette"></i> Nuevos Colores</h4>
                    <div class="tag-cloud" id="color-labels-list"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Referencias DOM
    const formInput = document.getElementById('form_model');
    const colorInput = document.getElementById('color_model');
    const boxForm = document.getElementById('box-form');
    const boxColor = document.getElementById('box-color');
    const nameForm = document.getElementById('name-form');
    const nameColor = document.getElementById('name-color');
    const submitBtn = document.getElementById('submit-btn');

    // Función para actualizar UI al seleccionar archivo
    function handleFileSelect(input, box, labelDiv) {
        input.addEventListener('change', () => {
            if (input.files.length > 0) {
                box.classList.add('active');
                labelDiv.textContent = input.files[0].name;
            } else {
                box.classList.remove('active');
                labelDiv.textContent = '';
            }
        });
    }

    handleFileSelect(formInput, boxForm, nameForm);
    handleFileSelect(colorInput, boxColor, nameColor);

    // Manejo del Envío
    document.getElementById('model-upload-form').addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Estado de carga
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
        submitBtn.disabled = true;

        const formData = new FormData(this);

        // Usamos la ruta original '/upload_model' que asumo existe en app.py o routes_api.py
        fetch('/upload_model', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Mostrar resultados
            displayLabels(data.form_labels, 'form-labels-list');
            displayLabels(data.color_labels, 'color-labels-list');
            
            // Restaurar botón
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            // Scroll suave hacia los resultados
            document.getElementById('model-info').scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error al subir los modelos. Revisa la consola.");
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });

    function displayLabels(labels, listId) {
        const labelsList = document.getElementById(listId);
        labelsList.innerHTML = '';
        if(labels && labels.length > 0){
            labels.forEach(label => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.textContent = label;
                labelsList.appendChild(tag);
            });
        } else {
            labelsList.innerHTML = '<span style="font-size:0.8rem; color:#999;">Sin etiquetas</span>';
        }
        document.getElementById('model-info').style.display = 'block';
    }
</script>
{% endblock %}