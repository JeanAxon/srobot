{% extends "layout/base.html" %}

{% block title %}Cinemática Inversa (XYZ){% endblock %}

{% block extra_css %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<link rel="stylesheet" href="{{ url_for('static', filename='css/configurar_movimientos.css') }}">

<style>
    /* Estilos extra específicos para inputs numéricos de CI (Jogging) */
    .coord-control {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 10px;
    }
    .coord-label { 
        width: 50px; 
        font-weight: bold; 
        color: var(--primary-color); 
        font-size: 0.9rem;
    }
    .coord-input { 
        width: 70px !important; 
        text-align: center; 
        margin: 0 !important; 
        font-weight: bold;
    }
    .btn-jog { 
        padding: 5px 10px; 
        background: #e2e8f0; 
        border: 1px solid #cbd5e1;
        border-radius: 4px; 
        cursor: pointer; 
        font-weight: bold;
        color: #475569;
        transition: all 0.1s;
    }
    .btn-jog:hover { background: #cbd5e1; color: #1e293b; }
    .btn-jog:active { transform: translateY(1px); }
</style>
{% endblock %}

{% block nav_left %}
    <a href="{{ url_for('web.opciones') }}" class="header-btn">
        <i class="fas fa-arrow-left"></i> Panel
    </a>
{% endblock %}

{% block content %}
<div class="control-grid">
    
    <div class="card-panel area-controls">
        <h3>
            <span><i class="fas fa-ruler-combined"></i> Control XYZ</span>
            <span id="status-ci" class="status-badge" style="background:#e0f2fe; color:#0284c7;">Listo</span>
        </h3>

        <div class="servo-control-group">
            <h4 style="font-size:0.9rem; color:#64748b; margin-bottom:10px;">Posición (mm)</h4>
            
            {% for axis in ['x', 'y', 'z'] %}
            <div class="coord-control">
                <span class="coord-label">{{ axis|upper }}</span>
                <button class="btn-jog" onclick="ajustarValor('{{ axis }}', -5)"><i class="fas fa-minus"></i></button>
                <input type="number" id="val-{{ axis }}" class="coord-input" value="0">
                <button class="btn-jog" onclick="ajustarValor('{{ axis }}', 5)"><i class="fas fa-plus"></i></button>
            </div>
            {% endfor %}
        </div>

        <div class="servo-control-group" style="margin-top:10px;">
            <h4 style="font-size:0.9rem; color:#64748b; margin-bottom:10px;">Orientación (Grados)</h4>
            
            {% for angle in ['roll', 'pitch', 'yaw'] %}
            <div class="coord-control">
                <span class="coord-label">{{ angle|capitalize }}</span>
                <button class="btn-jog" onclick="ajustarValor('{{ angle }}', -5)"><i class="fas fa-minus"></i></button>
                <input type="number" id="val-{{ angle }}" class="coord-input" value="0">
                <button class="btn-jog" onclick="ajustarValor('{{ angle }}', 5)"><i class="fas fa-plus"></i></button>
            </div>
            {% endfor %}
        </div>
        
        <div class="servo-control-group" style="margin-top:10px;">
            <div class="slider-label"><span>Gripper</span></div>
            <div class="gripper-btn-group">
                <button id="gripper-open" class="gripper-btn active">Abrir</button>
                <button id="gripper-close" class="gripper-btn">Cerrar</button>
            </div>
        </div>

        <div style="margin-top:15px;">
            <button id="btn-calcular-mover" class="btn-primary" style="width:100%; justify-content:center;">
                <i class="fas fa-calculator"></i> Calcular y Mover
            </button>
            <p style="font-size:0.75rem; color:#64748b; margin-top:5px; text-align:center;">
                El "Fantasma" muestra la posición objetivo.<br>
                El robot real se moverá al confirmar.
            </p>
        </div>
    </div>

    <div class="card-panel area-sim">
        <div class="sim-header">
            <h3><i class="fas fa-cube"></i> Previsualización</h3>
            <button id="btn-area-trabajo" class="header-btn" style="color:#64748b; background:white; border:1px solid #cbd5e1; padding:4px 10px;">
                <i class="fas fa-border-all"></i> Área
            </button>
        </div>
        <div id="robot-simulation"></div>
    </div>

    <div class="card-panel area-data">
        <h3><span><i class="fas fa-microchip"></i> Solución (Ángulos)</span></h3>
        <div class="kinematics-info" id="angulos-resultado">
            <span>Base: <b id="res-s1">-</b></span>
            <span>Hombro: <b id="res-s2">-</b></span>
            <span>Codo: <b id="res-s3">-</b></span>
            <span>M.Vert: <b id="res-s4">-</b></span>
            <span>M.Rot: <b id="res-s5">-</b></span>
        </div>
        
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
            <input type="text" id="point-name" placeholder="Nombre P. Interés">
            <button id="save-point-btn" class="btn-primary" style="width:100%; margin-top:5px;">
                <i class="fas fa-map-pin"></i> Guardar Coordenada
            </button>
        </div>
        <ul id="saved-points-list" class="movement-list" style="margin-top:10px; max-height:150px;"></ul>
    </div>
    
    <div class="card-panel area-sequence">
        <h3><span><i class="fas fa-layer-group"></i> Ruta Cartesiana</span></h3>
        <ul id="positions-list" class="movement-list">
            <li class="movement-item">Sin pasos</li>
        </ul>
        <div style="margin-top: 10px; display:flex; gap:5px;">
             <button id="save-position" class="btn-primary" style="flex:1; font-size:0.8rem;">+ Paso</button>
             <button id="save-movement" class="btn-primary" style="flex:1; background:var(--success-color); font-size:0.8rem;">Guardar Ruta</button>
        </div>
        <input type="text" id="movement-name" placeholder="Nombre Ruta..." style="margin-top:5px;">
    </div>
    
    <div class="card-panel area-library" style="grid-column: 1 / -1;">
        <h3>Biblioteca de Movimientos (Solo lectura en modo CI)</h3>
        <ul id="movements-list" class="movement-list" style="max-height:150px;"></ul>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/robot_api.js') }}"></script>

<script src="{{ url_for('static', filename='js/robot_sim.js') }}"></script>

<script src="{{ url_for('static', filename='js/kinematics.js') }}"></script>

<script src="{{ url_for('static', filename='js/robot_main_ci.js') }}"></script>
{% endblock %}