{% extends "layout/base.html" %}

{% block title %}Configurar Movimientos{% endblock %}

{% block extra_css %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<link rel="stylesheet" href="{{ url_for('static', filename='css/configurar_movimientos.css') }}">
{% endblock %}

{% block nav_left %}
    <a href="{{ url_for('web.opciones') }}" class="header-btn">
        <i class="fas fa-arrow-left"></i> Panel
    </a>
{% endblock %}

{% block content %}
<div class="control-grid">
    
    <div class="card-panel area-controls">
        <h3>
            <span><i class="fas fa-gamepad"></i> Control Manual</span>
            <span id="speed-display" class="status-badge status-connected" style="background: #e0f2fe; color: var(--primary-color);">Vel: 50</span>
        </h3>

        <div class="servo-control-group">
            <div class="slider-label">
                <span><i class="fas fa-tachometer-alt"></i> Velocidad Global</span>
            </div>
            <input type="range" id="velocidad" min="0" max="100" value="50">
        </div>

        <div class="servo-control-group">
            <div class="slider-label">
                <span><i class="fas fa-hand-rock"></i> Gripper (Pinza)</span>
                <span id="servo6-val" style="color: var(--primary-color);">90</span>
            </div>
            <div class="gripper-btn-group">
                <button id="gripper-open" class="gripper-btn active"><i class="fas fa-box-open"></i> Abrir</button>
                <button id="gripper-close" class="gripper-btn"><i class="fas fa-box"></i> Cerrar</button>
            </div>
        </div>

        {% set servo_labels = {1:"Base (S1)", 2:"Hombro (S2)", 3:"Codo (S3)", 4:"Muñeca V (S4)", 5:"Muñeca Rot (S5)"} %}
        {% for i in range(5, 0, -1) %}
        <div class="servo-control-group" id="container-servo{{ i }}">
            <div class="slider-label">
                <span>{{ servo_labels[i] }}</span>
                <span id="servo{{ i }}-val" style="color: var(--primary-color);">90</span>°
            </div>
            <input type="range" id="servo{{ i }}" min="0" max="180" value="90">
        </div>
        {% endfor %}

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button id="btn-home" class="btn-primary" style="flex:1; background:#64748b;">
                <i class="fas fa-undo"></i> Reset
            </button>
            <button id="save-position" class="btn-primary" style="flex:1;">
                <i class="fas fa-plus-circle"></i> Agregar Paso
            </button>
        </div>
    </div>

    <div class="card-panel area-sim">
        <div class="sim-header">
            <h3><i class="fas fa-cube"></i> Gemelo Digital</h3>
            <button id="btn-area-trabajo" class="header-btn" style="color: #64748b; background: white; border: 1px solid #cbd5e1; padding: 4px 10px;">
                <i class="fas fa-border-all"></i> Mostrar Área
            </button>
        </div>
        <div id="robot-simulation"></div>
    </div>

    <div class="card-panel area-data">
        <h3><span><i class="fas fa-map-marker-alt"></i> Coordenadas</span></h3>
        
        <div class="kinematics-info">
            <span>X: <b id="gripper-x">0</b></span>
            <span>Roll: <b id="gripper-roll">0</b>°</span>
            <span>Y: <b id="gripper-y">0</b></span>
            <span>Pitch: <b id="gripper-pitch">0</b>°</span>
            <span>Z: <b id="gripper-z">0</b></span>
            <span>Yaw: <b id="gripper-yaw">0</b>°</span>
        </div>
        
        <div style="margin-top:15px; display:flex; gap:8px;">
            <input type="text" id="point-name" placeholder="Nombre Punto" style="margin:0;">
            <button id="save-point-btn" class="btn-primary" style="padding: 0 1rem;"><i class="fas fa-save"></i></button>
        </div>
        
        <div style="margin-top: 15px;">
            <h4 style="font-size: 0.85rem; color: #64748b; margin-bottom: 8px; text-align: left;">Puntos Guardados:</h4>
            <ul id="saved-points-list" class="movement-list" style="max-height: 120px;">
                <li class="movement-item">Cargando...</li>
            </ul>
        </div>
    </div>

    <div class="card-panel area-sequence">
        <h3><span><i class="fas fa-layer-group"></i> Secuencia Actual</span></h3>
        
        <ul id="positions-list" class="movement-list">
            <li class="movement-item" style="color:#94a3b8; justify-content:center;">Sin pasos guardados</li>
        </ul>
        
        <div style="margin-top: 15px; display:flex; gap:8px;">
            <input type="text" id="movement-name" placeholder="Nombre de la secuencia..." style="margin:0;">
            <button id="save-movement" class="btn-primary" style="background: var(--success-color);">
                <i class="fas fa-save"></i> Guardar Todo
            </button>
        </div>
    </div>

    <div class="card-panel area-library">
        <h3><span><i class="fas fa-folder-open"></i> Biblioteca de Movimientos</span></h3>
        <ul id="movements-list" class="movement-list" style="height: 100%; max-height: 300px; border:none;">
            <li class="movement-item">Cargando...</li>
        </ul>
    </div>

    <div class="card-panel area-inspector">
        <h3>
            <span><i class="fas fa-search"></i> Inspector</span>
            <button id="clear-loaded-movement" class="btn-icon text-red" title="Limpiar" onclick="quitarMovimientoCargado()">
                <i class="fas fa-times"></i>
            </button>
        </h3>
        
        <ul id="loaded-movement-list" class="movement-list" style="background: #f8fafc;">
            <li class="movement-item" style="color:#94a3b8; justify-content:center;">Selecciona un movimiento</li>
        </ul>
    </div>

</div>

<div id="countdown-overlay">
    <div class="countdown-number" id="countdown-text">3</div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/robot_api.js') }}"></script>
<script src="{{ url_for('static', filename='js/robot_sim.js') }}"></script>
<script src="{{ url_for('static', filename='js/robot_main.js') }}"></script>
{% endblock %}